---
title: "POMP_GroupLevel_ManuscriptOutline_v4"
author: "Madeline Peters, Aaron King, Nina Wale"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Set-up

## Packages
```{r packages, include=FALSE}
library(tidyverse)
library(stringi)
library(doParallel)
library(pomp)
library(panelPomp)
library(ggpubr)
library(scales)
library(Rbeast)
library(tseries)
```

## Set working directory
Working directory should contain the files "POMP_GroupLevel_DataPrep.R", "m5pf4.rds", and "m6sm1.rds", the latter two of which are available from the "bdd" GitHub directory under "code/results".
```{r setwd}
setwd("~/Documents/GitHub/bdd/nw11_hier/final_files/Manuscript/")
```

## Set colour palette
```{r palette}
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
```

## Load in and prepare data
The object "flow" is the original, raw data, while "group_traj" contains the group-level median and confidence intervals for a number of variables output by the model.
```{r data}
source("POMP_GroupLevel_DataPrep.R")
```

# Analysis

## To what extent does RBC homeostasis that we observe in infected mice conform to the models used in malaria biology?

### Figure 1A
Assumption: RBC production is a linear function of erythrocyte density.
```{r fig1A}
group_traj |>
  filter(pABA=="0%",variable%in%c("E","R")) |>
  select(-lo,-hi,-pABA,-box) |>
  pivot_wider(names_from="variable",values_from="med") |>
  mutate(lagE=lag(E)) |>
  filter(time<=20) |>
  ggplot()+
  geom_path(aes(x=lagE,y=R),linewidth=2,col=cbPalette[2])+
  geom_text(aes(x=lagE,y=R,label=time))+
  xlab("Erythrocyte density (time t-1)")+
  ylab("Reticulocyte supply (time t)")+
  theme_bw()+
  theme(
    strip.background=element_blank(),
    panel.grid = element_blank(),
    legend.position=c(0.2,0.8),
    axis.title=element_text(size=15),
    axis.text=element_text(size=13),
    legend.text=element_text(size=14))
  
```

### Figure 1B
Assumption: RBC removal rate = 1/40 (day^-1)
```{r fig1B}
group_traj |>
  filter(pABA=="0%",variable%in%c("Qun")) |>
  filter(time<=20) |>
  ggplot()+
  geom_line(aes(x=time,y=med),linewidth=2,col=cbPalette[2])+
  geom_ribbon(aes(x=time,ymin=lo,ymax=hi),alpha=0.2,fill=cbPalette[2])+
  geom_hline(yintercept=(1-exp(-1/40)))+
  xlab("Day post-infection")+
  ylab("Probability uRBC removed")+
  theme_bw()+
  theme(
    strip.background=element_blank(),
    panel.grid = element_blank(),
    legend.position=c(0.2,0.8),
    axis.title=element_text(size=15),
    axis.text=element_text(size=13),
    legend.text=element_text(size=14))

group_traj |>
  filter(pABA=="Uninfected",variable%in%c("Qun")) |>
  filter(time<=20) |>
  ggplot()+
  geom_line(aes(x=time,y=med),linewidth=2,col=cbPalette[1])+
  geom_ribbon(aes(x=time,ymin=lo,ymax=hi),alpha=0.2,fill=cbPalette[1])+
  geom_hline(yintercept=(1-exp(-1/40)))+
  xlab("Day post-infection")+
  ylab("Probability uRBC removed")+
  theme_bw()+
  theme(
    strip.background=element_blank(),
    panel.grid = element_blank(),
    legend.position=c(0.2,0.8),
    axis.title=element_text(size=15),
    axis.text=element_text(size=13),
    legend.text=element_text(size=14))

#group_traj |>
  #filter(pABA=="0%",variable%in%c("M")) |>
  #filter(time<=20) |>
  #select(-lo,-hi,-pABA,-box) |>
  #mutate(prob=(1/40)/((1/40)+(0.000004*med))*(1-exp(-(1/40)-(0.000004*med))))
```
### Figure 2

```{r timeseriespABA}
group_traj |>
  filter(pABA=="0%",variable%in%c("R","N","Nq")) |>
  mutate(variable_name=case_match(variable,
                                  "R"~"Reticulocytes",
                                  "N"~"Indiscriminate killing",
                                  "Nq"~"Removed uRBCs"
                                 )) |>
  ggplot()+
  geom_line(aes(x=time,y=med),col=cbPalette[2])+
  geom_ribbon(aes(x=time,ymin=lo,ymax=hi),fill=cbPalette[2],alpha=0.2)+
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x), 
                labels=trans_format('log10',math_format(10^.x)))+ 
  xlab("Day post-infection")+ylab("Density per microlitre")+
  theme_bw()+
  facet_grid(variable_name~.,scales="free_y")+
  theme(strip.background=element_blank(),
        panel.grid = element_blank(),
        legend.position="right",
        axis.title=element_text(size=15),
        axis.text=element_text(size=13),
        legend.text=element_text(size=14),
        strip.text=element_text(size=12)
  )


```

Use BEAST package to detect change points in reticulocyte and indiscriminate killing time series forpABA = 0% (infected) treatment.
```{r phases, include=FALSE}
df0<-group_traj |>
  filter(pABA=="0%",variable%in%c("R","N","Nq"),time<=21) |>
  select(-lo,-hi) |>
  pivot_wider(names_from="variable",values_from="med")

yR0<-df0$R
yN0<-df0$N
yNq0<-df0$Nq

beastR0<-beast(yR0,season="none")
beastN0<-beast(yN0,season="none")
beastNq0<-beast(yNq0,season="none")
```

Print the results:
```{r phaseResults}
ncpR0<-which(beastR0$trend$ncpPr==max(beastR0$trend$ncpPr))-1
paste("Number of change points for reticulocytes in the infected group is ",ncpR0,sep="")
if (ncpR0>0){
  paste("A change point for reticulocytes in the infected group is ",beastR0$trend$cp[1:ncpR0]," or day ",beastR0$trend$cp[1:ncpR0]-1,sep="")
}

ncpN0<-which(beastN0$trend$ncpPr==max(beastN0$trend$ncpPr))-1
paste("Number of change points for indiscriminate killing in the infected group is ",ncpN0,sep="")
if (ncpN0>0){
  paste("A change point for indiscriminate killing in the infected group is ",beastN0$trend$cp[1:ncpN0]," or day ",beastN0$trend$cp[1:ncpN0]-1,sep="")
}

ncpNq0<-which(beastNq0$trend$ncpPr==max(beastNq0$trend$ncpPr))-1
paste("Number of change points for number uRBCs cleared in the infected group is ",ncpNq0,sep="")
if (ncpNq0>0){
  paste("A change point for number uRBCs cleared in the infected group is ",beastNq0$trend$cp[1:ncpNq0]," or day ",beastNq0$trend$cp[1:ncpNq0]-1,sep="")
}
```

Visualise the results of the BEAST package:
```{r beastplots}
plot(beastR0)
plot(beastN0)
plot(beastNq0)
```

```{r ReticvsTime_Phases_UninfInf}
group_traj |>
  filter(pABA=="0%",variable=="R",time<=21) |>
  ggplot()+
  geom_ribbon(aes(x=time,ymin=lo,ymax=hi),fill=cbPalette[2],alpha=0.2)+
  geom_line(aes(x=time,y=med),col=cbPalette[2],linewidth=2)+
  geom_bracket(
      xmin = 0.1, xmax = 9.9, y.position = 6.5,
      label = "Stress\nerythropoiesis", tip.length = c(0.01, 0.01),hjust=0.5
    )+
  geom_bracket(
      xmin = 10.1, xmax = 20.9, y.position = 6.5,
      label = "Reticulocyte supply ~ erythrocyte density", tip.length = c(0.01, 0.01),hjust=0.5
    )+
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x), 
                  labels=trans_format('log10',math_format(10^.x)))+ 
  xlab("Day post-infection")+
  ylab("Reticulocyte supply (density per microlitre)")+
  theme_bw()+
  theme(
    strip.background=element_blank(),
    panel.grid = element_blank(),
    legend.position=c(0.2,0.7),
    axis.title=element_text(size=15),
    axis.text=element_text(size=13),
    legend.text=element_text(size=14))
```


# To what extent does RBC homeostasis process change with parasite traits?

## Figure 3A
```{r fig3A}
group_traj |>
  filter(variable%in%c("R","N","Nq")) |>
  mutate(variable_name=case_match(variable,
                                  "R"~"Reticulocytes",
                                  "N"~"Indiscriminate killing",
                                  "Nq"~"Removed uRBCs"
                                 )) |>
  ggplot()+
  geom_line(aes(x=time,y=med,col=pABA))+
  geom_ribbon(aes(x=time,ymin=lo,ymax=hi,fill=pABA),alpha=0.2)+
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x), 
                labels=trans_format('log10',math_format(10^.x)))+ 
  xlab("Day post-infection")+ylab("Density per microlitre")+
  scale_colour_manual(values=cbPalette)+
  scale_fill_manual(values=cbPalette)+
  theme_bw()+
  facet_grid(.~variable_name,scales="free_y")+
  theme(strip.background=element_blank(),
        panel.grid = element_blank(),
        legend.position="right",
        axis.title=element_text(size=15),
        axis.text=element_text(size=13),
        legend.text=element_text(size=14),
        strip.text=element_text(size=12)
  )

```

