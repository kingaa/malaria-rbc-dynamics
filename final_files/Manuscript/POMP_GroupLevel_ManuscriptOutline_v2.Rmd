---
title: "POMP_GroupLevel_ManuscriptOutline_v2"
author: "Madeline Peters, Aaron King, Nina Wale"
date: '`r Sys.Date()`'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Set-up

## Packages
```{r packages}
library(tidyverse)
library(stringi)
library(doParallel)
library(pomp)
library(panelPomp)
library(ggpubr)
library(scales)
library(Rbeast)
library(changepoint)
library(bcp)
```

## Set working directory
Working directory should contain the files "POMP_GroupLevel_DataPrep.R", "m5pf4.rds", and "m6sm1.rds", the latter two of which are available from the "bdd" GitHub directory under "code/results".
```{r setwd}
setwd("~/Documents/GitHub/bdd/nw11_hier/final_files/Manuscript/")
```

## Set colour palette
```{r palette}
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
```

## Load in and prepare data
The object "flow" is the original, raw data, while "group_traj" contains the group-level median and confidence intervals for a number of variables output by the model.
```{r data}
source("POMP_GroupLevel_DataPrep.R")
```

# Analysis

## Uninfected versus infected
First we'll create a data frame that contains ONLY the uninfected (i.e., control) mice and the mice receiving the 0% pABA treatment.
```{r UninfInfDF}
group_UninfInf <- group_traj |>
  filter(time<=30,
         pABA%in%c("Uninfected","0%"),
         variable%in%c("E","R","K","N","W","Qpn","Qps","Qun","Qpw","Qus")) |>
  mutate(type=case_match(pABA,
                         "Uninfected"~"Uninfected",
                         "0%"~"Infected"),
         variable_name=case_match(variable,
                                  "E"~"Erythrocytes",
                                  "R"~"Reticulocytes",
                                  "K"~"Parasites",
                                  "N"~"Indiscriminate killing",
                                  "W"~"Targeted killing",
                                  "Qpn"~"Qpn",
                                  "Qps"~"Qps",
                                  "Qun"~"Qun",
                                  "Qpw"~"Qpw",
                                  "Qus"~"Qus"))
head(group_UninfInf)
```

## Can RBC flux be divided into separate phases?

### Visualisation
```{r UninfInfPhaseVis}
group_UninfInf |>
  filter(variable%in%c("R","N")) |>
  ggplot()+
  geom_line(aes(x=time,y=med,col=type))+
  geom_ribbon(aes(x=time,ymin=lo,ymax=hi,fill=type),alpha=0.2)+
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x), 
                labels=trans_format('log10',math_format(10^.x)))+ 
  scale_colour_manual(values=cbPalette[c(2,1)],name=NULL)+
  scale_fill_manual(values=cbPalette[c(2,1)],name=NULL)+
  xlab("Day post-infection")+ylab("Density per microlitre")+
  theme_bw()+
  facet_grid(variable_name~.,scales="free_y")+
  theme(strip.background=element_blank(),
        panel.grid = element_blank(),
        legend.position="right",
        axis.title=element_text(size=15),
        axis.text=element_text(size=13),
        legend.text=element_text(size=14),
        strip.text=element_text(size=12)
  )
```

### Uninfected analysis
```{r UninfPhases}
#Reticulocytes
tmp <- group_UninfInf |> filter(pABA=="Uninfected",variable=="R")
y <- tmp$med

out<-beast(y, season='none', print.options=0)
plot(out)
print(out)

ansvar <- cpt.meanvar(y)
plot(ansvar)
print(ansvar)
tmp$time[ansvar@cpts]

out.bcp <- bcp(y,return.mcmc=TRUE)
plot(out.bcp)

#Indiscriminate killing
tmp <- group_UninfInf |> filter(pABA=="Uninfected",variable=="N")
y <- tmp$med

out<-beast(y, season='none', print.options=0)
plot(out)
print(out)

ansvar <- cpt.meanvar(y)
plot(ansvar)
print(ansvar)
tmp$time[ansvar@cpts]

out.bcp <- bcp(y,return.mcmc=TRUE)
plot(out.bcp)

```

### Infected analysis
```{r InfPhases}
#Reticulocytes
tmp <- group_UninfInf |> filter(pABA=="0%",variable=="R")
y <- tmp$med

out<-beast(y, season='none', print.options=0)
plot(out)
print(out)

ansvar <- cpt.meanvar(y)
plot(ansvar)
print(ansvar)
tmp$time[ansvar@cpts]

out.bcp <- bcp(y,return.mcmc=TRUE)
plot(out.bcp)

out.cpop<-cpop(y=tmp$med,
     x=tmp$time,
     grid=tmp$time)
plot(out.cpop)
out.cpop@changepoints

#Indiscriminate killing
tmp <- group_UninfInf |> filter(pABA=="0%",variable=="N")
y <- tmp$med

out<-beast(y, season='none', print.options=0)
plot(out)
print(out)

ansvar <- cpt.meanvar(y)
plot(ansvar)
print(ansvar)
tmp$time[ansvar@cpts]

out.bcp <- bcp(y,return.mcmc=TRUE)
plot(out.bcp)

out.cpop<-cpop(y=tmp$med,
     x=tmp$time,
     grid=tmp$time)
plot(out.cpop)
out.cpop@changepoints
```

## Does Plasmodium infection alter RBC flux compared to that in the absence of infection?

```{r }
tmp1<-group_UninfInf |> filter(pABA=="Uninfected",variable=="R")
Xi<-tmp1$med

tmp2<-group_UninfInf |> filter(pABA=="0%",variable=="R")
Yi<-tmp2$med

diff<-Xi-Yi

mean.diff<-mean(diff)
sd.diff<-sd(diff)

Td<-mean.diff/(sd.diff/sqrt(length(Xi)))
df = length(Xi)-1

#T-value (two-tailed) for alpha = 0.05 and df = 20: +/-2.086

```

## Is RBC flux a linear function of erythrocyte density?

# Different parasite growth rates (pABA treatments)

## Are these phases observed under different parasite growth rates?

## Is RBC flux dependent on parasite growth rate during Phase I?

## Is RBC flux dependent on parasite growth rate during Phase II?

## What is the median lifespan of an RBC born on d0, 7 10 and 15?
```{r lifespan}
#Uninfected
group_traj |> filter(pABA=="Uninfected",variable=="Qus") |>
  select(time,med) -> tmp
day0timeUninf <- tmp$time[min(which(cumprod(tmp$med)<=0.5))]

group_traj |> filter(time>=7,pABA=="Uninfected",variable=="Qus") |>
  select(time,med) -> tmp2
day7timeUninf <- tmp2$time[min(which(cumprod(tmp2$med)<=0.5))]-7

group_traj |> filter(time>=10,pABA=="Uninfected",variable=="Qus") |>
  select(time,med) -> tmp3
day10timeUninf <- tmp3$time[min(which(cumprod(tmp3$med)<=0.5))]-10
  
group_traj |> filter(time>=15,pABA=="Uninfected",variable=="Qus") |>
  select(time,med) -> tmp4
day15timeUninf <- tmp4$time[min(which(cumprod(tmp4$med)<=0.5))]-15

group_traj |> filter(time>=20,pABA=="Uninfected",variable=="Qus") |>
  select(time,med) -> tmp5
day20timeUninf <- tmp5$time[min(which(cumprod(tmp5$med)<=0.5))]-20

#pABA 0%
group_traj |> filter(pABA=="0%",variable=="Qus") |>
  select(time,med) -> tmp
day0time0 <- tmp$time[min(which(cumprod(tmp$med)<=0.5))]

group_traj |> filter(time>=7,pABA=="0%",variable=="Qus") |>
  select(time,med) -> tmp2
day7time0 <- tmp2$time[min(which(cumprod(tmp2$med)<=0.5))]-7

group_traj |> filter(time>=10,pABA=="0%",variable=="Qus") |>
  select(time,med) -> tmp3
day10time0 <- tmp3$time[min(which(cumprod(tmp3$med)<=0.5))]-10

group_traj |> filter(time>=15,pABA=="0%",variable=="Qus") |>
  select(time,med) -> tmp4
day15time0 <- tmp4$time[min(which(cumprod(tmp4$med)<=0.5))]-15

group_traj |> filter(time>=20,pABA=="0%",variable=="Qus") |>
  select(time,med) -> tmp5
day20time0 <- tmp5$time[min(which(cumprod(tmp5$med)<=0.5))]-20

#pABA 0.0005%
group_traj |> filter(pABA=="0.0005%",variable=="Qus") |>
  select(time,med) -> tmp
day0time0.0005 <- tmp$time[min(which(cumprod(tmp$med)<=0.5))]

group_traj |> filter(time>=7,pABA=="0.0005%",variable=="Qus") |>
  select(time,med) -> tmp2
day7time0.0005 <- tmp2$time[min(which(cumprod(tmp2$med)<=0.5))]-7

group_traj |> filter(time>=10,pABA=="0.0005%",variable=="Qus") |>
  select(time,med) -> tmp3
day10time0.0005 <- tmp3$time[min(which(cumprod(tmp3$med)<=0.5))]-10

group_traj |> filter(time>=15,pABA=="0.0005%",variable=="Qus") |>
  select(time,med) -> tmp4
day15time0.0005 <- tmp4$time[min(which(cumprod(tmp4$med)<=0.5))]-15

group_traj |> filter(time>=20,pABA=="0.0005%",variable=="Qus") |>
  select(time,med) -> tmp5
day20time0.0005 <- tmp5$time[min(which(cumprod(tmp5$med)<=0.5))]-20

#pABA 0.005%
group_traj |> filter(pABA=="0.005%",variable=="Qus") |>
  select(time,med) -> tmp
day0time0.005 <- tmp$time[min(which(cumprod(tmp$med)<=0.5))]

group_traj |> filter(time>=7,pABA=="0.005%",variable=="Qus") |>
  select(time,med) -> tmp2
day7time0.005 <- tmp2$time[min(which(cumprod(tmp2$med)<=0.5))]-7

group_traj |> filter(time>=10,pABA=="0.005%",variable=="Qus") |>
  select(time,med) -> tmp3
day10time0.005 <- tmp3$time[min(which(cumprod(tmp3$med)<=0.5))]-10

group_traj |> filter(time>=15,pABA=="0.005%",variable=="Qus") |>
  select(time,med) -> tmp4
day15time0.005 <- tmp4$time[min(which(cumprod(tmp4$med)<=0.5))]-15

group_traj |> filter(time>=20,pABA=="0.005%",variable=="Qus") |>
  select(time,med) -> tmp5
day20time0.005 <- tmp5$time[min(which(cumprod(tmp5$med)<=0.5))]-20

#pABA 0.05%
group_traj |> filter(pABA=="0.05%",variable=="Qus") |>
  select(time,med) -> tmp
day0time0.05 <- tmp$time[min(which(cumprod(tmp$med)<=0.5))]

group_traj |> filter(time>=7,pABA=="0.05%",variable=="Qus") |>
  select(time,med) -> tmp2
day7time0.05 <- tmp2$time[min(which(cumprod(tmp2$med)<=0.5))]-7

group_traj |> filter(time>=10,pABA=="0.05%",variable=="Qus") |>
  select(time,med) -> tmp3
day10time0.05 <- tmp3$time[min(which(cumprod(tmp3$med)<=0.5))]-10

group_traj |> filter(time>=15,pABA=="0.05%",variable=="Qus") |>
  select(time,med) -> tmp4
day15time0.05 <- tmp4$time[min(which(cumprod(tmp4$med)<=0.5))]-15

group_traj |> filter(time>=20,pABA=="0.05%",variable=="Qus") |>
  select(time,med) -> tmp5
day20time0.05 <- tmp5$time[min(which(cumprod(tmp5$med)<=0.5))]-20

ggplot()+
  geom_line(
    aes(
      x=c(0,7,10,15),
      y=c(day0timeUninf,day7timeUninf,day10timeUninf,day15timeUninf)
        ),
    col=cbPalette[1]
    )+
  geom_line(
    aes(
      x=c(0,7,10,15),
      y=c(day0time0,day7time0,day10time0,day15time0)
    ),
    col=cbPalette[2]
  )+
  geom_line(
    aes(
      x=c(0,7,10,15,20),
      y=c(day0time0.0005,day7time0.0005,day10time0.0005,day15time0.0005,day20time0.0005)
    ),
    col=cbPalette[3]
  )+
  geom_line(
    aes(
      x=c(0,7,10,15,20),
      y=c(day0time0.005,day7time0.005,day10time0.005,day15time0.005,day20time0.005)
    ),
    col=cbPalette[4]
  )+
  geom_line(
    aes(
      x=c(0,7,10,15,20),
      y=c(day0time0.05,day7time0.05,day10time0.05,day15time0.05,day20time0.05)
    ),
    col=cbPalette[5]
  )+
  xlab("Day post-infection")+ylab("Median lifespan of new RBC (days)")+
  theme_bw()+
  theme(strip.background=element_blank(),
        legend.position="right",
        axis.title=element_text(size=15),
        axis.text=element_text(size=13),
        legend.text=element_text(size=14)
  )
```